#!/bin/bash

set -o nounset

declare exitOption=''

main() {
    exitOption='/(e)xit'

    sub_volumes
}

confirm() {
    read -r -n 1 -p "> $1 (y/N${exitOption})? "
    echo
    if [[ $REPLY =~ ^[Ee]$ ]]; then
        end
        exit
    fi
    [[ $REPLY =~ ^[Yy]$ ]]
}

btrfs() {
    /usr/sbin/btrfs "$@"
}

sub_volumes() {
    confirm "Keep unwanted content out of /home snapshots" || return

    move_subvolume "${HOME}/.cache"
    move_subvolume "${HOME}/.var"
}

move_subvolume() {
    local directory=$1
    mkdir -p "$directory" || exit
    sudo btrfs subvolume show "$directory" &>/dev/null && exit

    confirm "Create subvolume for ${directory}?" || return

    mv "$directory"{,.old} \
        && btrfs subvolume create "$directory" \
        && cp -a "${directory}"{.old/.,/} \
        && rm -rf "${directory}".old
}

main
